<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>CNM Project Plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:sans-serif;background:#f4f6f8}
header{background:#0a3d62;color:#fff;padding:12px}
.tabs button{margin-right:6px;padding:6px 12px;border:none;border-radius:6px}
.tabs button.active{background:#fff;color:#0a3d62;font-weight:bold}
.plan-wrapper{position:relative}
#floorPlan{width:100%}
#markerLayer{position:absolute;inset:0}
.marker{position:absolute;width:22px;height:22px;background:red;border-radius:50%;transform:translate(-50%,-50%)}
.popup{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:16px;box-shadow:0 -2px 12px rgba(0,0,0,.3)}
.hidden{display:none}
</style>
</head>

<body>

<header>
  <h3 id="projectName"></h3>
  <div class="tabs" id="floorTabs"></div>
</header>

<div class="plan-wrapper">
  <img id="floorPlan">
  <div id="markerLayer"></div>
</div>

<div id="popup" class="popup hidden">
  <h4 id="pName"></h4>
  <p id="pCode"></p>
  <a id="pLink" target="_blank">เปิดโฟลเดอร์</a><br><br>
  <button onclick="closePopup()">ปิด</button>
</div>

<script>
/* ======================
   CONFIG
====================== */
const API_URL = "https://script.google.com/macros/s/AKfycbzgX8LdxBXXJ_6W7VAvWmiS-E9iIagKsVbSLMjcEt26gZ7lv9yCvohLBSDbGejt1UcB/exec";

const urlParams = new URLSearchParams(window.location.search);
const PROJECT_ID = urlParams.get("project_id");
  
if (!PROJECT_ID) {
  alert("ไม่พบ project_id");
}

/* ======================
   STATE
====================== */
let floors = [];
let items = [];
let currentFloor = "";

/* ======================
   INIT
====================== */
init();

async function init() {
  const project = await fetchData("project");
  floors = await fetchData("floors");
  items = await fetchData("items");

  document.getElementById("projectName").innerText =
    project.PROJECT_NAME + " (" + project.PROJECT_CODE + ")";

  currentFloor = floors[0].FLOOR_ID;
  renderTabs();
  loadFloor();
}

/* ======================
   API
====================== */
async function fetchData(action) {
  const res = await fetch(`${API_URL}?action=${action}&project_id=${PROJECT_ID}`);
  return res.json();
}

/* ======================
   UI
====================== */
function renderTabs() {
  const tabs = document.getElementById("floorTabs");
  tabs.innerHTML = "";

  floors.forEach(f => {
    const btn = document.createElement("button");
    btn.innerText = f.FLOOR_NAME;
    if (f.FLOOR_ID === currentFloor) btn.classList.add("active");
    btn.onclick = () => {
      currentFloor = f.FLOOR_ID;
      renderTabs();
      loadFloor();
    };
    tabs.appendChild(btn);
  });
}

function loadFloor() {
  const floor = floors.find(f => f.FLOOR_ID === currentFloor);
  document.getElementById("floorPlan").src = floor.PLAN_IMAGE_URL;
  renderMarkers();
}

function renderMarkers() {
  const layer = document.getElementById("markerLayer");
  layer.innerHTML = "";

  items
    .filter(i => i.FLOOR_ID === currentFloor)
    .forEach(i => {
      const m = document.createElement("div");
      m.className = "marker";
      m.style.left = i.X + "%";
      m.style.top = i.Y + "%";
      m.onclick = () => openPopup(i);
      layer.appendChild(m);
    });
}

function openPopup(i) {
  document.getElementById("pName").innerText = i.PRODUCT_NAME;
  document.getElementById("pCode").innerText = i.PRODUCT_CODE;
  document.getElementById("pLink").href = i.DRIVE_FOLDER;
  document.getElementById("popup").classList.remove("hidden");
}

function closePopup() {
  document.getElementById("popup").classList.add("hidden");
}
</script>

</body>
</html>
