<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>CNM Project Plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f4f6f8;
}

header {
  background: #0a3d62;
  color: #fff;
  padding: 12px;
}

header h2 {
  margin: 0;
  font-size: 18px;
}

#floorButtons {
  margin-top: 8px;
}

#floorButtons button {
  margin-right: 6px;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

#floorButtons button.active {
  background: #fff;
  color: #0a3d62;
  font-weight: bold;
}

#planWrap {
  position: relative;
  width: 100%;
}

#planImage {
  width: 100%;
  display: block;
}

.marker {
  position: absolute;
  transform: translate(-50%, -100%);
  background: red;
  color: #fff;
  font-size: 12px;
  padding: 4px 6px;
  border-radius: 50%;
  cursor: pointer;
}
</style>
</head>

<body>

<header>
  <h2 id="projectTitle">กำลังโหลด...</h2>
  <div id="floorButtons"></div>
</header>

<div id="planWrap">
  <img id="planImage">
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxkTfIiklDtPoDGT42Dy9ChdTXGgwlAztS1uFg6LYnAMYciOIP02UEFUvuQQo6BhQk_/exec";
const PROJECT_ID = new URLSearchParams(location.search).get("project_id");

/* ================= STATE ================= */
let floors = [];
let items = [];
let currentFloor = null;

/* ================= INIT ================= */
if (!PROJECT_ID) {
  alert("ไม่พบ project_id");
} else {
  init();
}

async function init() {
  await loadProject();
  await loadFloors();
  await loadItems();
  if (floors.length > 0) selectFloor(floors[0].FLOOR_ID);
}

/* ================= LOADERS ================= */
async function loadProject() {
  const res = await fetch(`${API_URL}?action=project&project_id=${PROJECT_ID}`);
  const p = await res.json();
  if (!p) {
    alert("ไม่พบโครงการ");
    throw new Error("Project not found");
  }
  document.getElementById("projectTitle").textContent =
    `${p.PROJECT_NAME} (${p.PROJECT_CODE})`;
}

async function loadFloors() {
  const res = await fetch(`${API_URL}?action=floors&project_id=${PROJECT_ID}`);
  floors = await res.json();

  const wrap = document.getElementById("floorButtons");
  wrap.innerHTML = "";

  floors.forEach(f => {
    const b = document.createElement("button");
    b.textContent = f.FLOOR_NAME;
    b.onclick = () => selectFloor(f.FLOOR_ID);
    wrap.appendChild(b);
  });
}

async function loadItems() {
  const res = await fetch(`${API_URL}?action=items&project_id=${PROJECT_ID}`);
  items = await res.json();
}

/* ================= VIEW ================= */
function selectFloor(floorId) {
  currentFloor = floorId;

  document.querySelectorAll("#floorButtons button")
    .forEach(b => b.classList.remove("active"));

  const idx = floors.findIndex(f => f.FLOOR_ID === floorId);
  document.querySelectorAll("#floorButtons button")[idx].classList.add("active");

  const floor = floors.find(f => f.FLOOR_ID === floorId);
  const img = document.getElementById("planImage");
  img.src = floor.PLAN_IMAGE_URL;

  img.onload = renderMarkers;
}

function renderMarkers() {
  document.querySelectorAll(".marker").forEach(m => m.remove());

  const wrap = document.getElementById("planWrap");
  const list = items.filter(i => i.FLOOR_ID === currentFloor);

  list.forEach((it, i) => {
    if (!it.X || !it.Y) return;

    const m = document.createElement("div");
    m.className = "marker";
    m.textContent = i + 1;
    m.style.left = it.X + "%";
    m.style.top = it.Y + "%";
    m.onclick = () => window.open(it.DRIVE_FOLDER, "_blank");

    wrap.appendChild(m);
  });
}
</script>

</body>
</html>
