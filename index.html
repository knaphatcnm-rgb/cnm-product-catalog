<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>CNM Access</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
กำลังตรวจสอบสิทธิ์...

<script>
const LIFF_ID = "2008736700-X7cUjaUv";
const API_URL = "https://script.google.com/macros/s/AKfycbxio7JQBKgdmO5r7sR8KIO1e60DYGP3SLPNefzDVrgouf9zjzKO4HRABBSlg7Kiwenw/exec";

async function start() {
  try {
    await liff.init({ liffId: LIFF_ID });

    // ต้องเปิดผ่าน LINE เท่านั้น
    if (!liff.isInClient()) {
      document.body.innerText =
        "กรุณาเปิดผ่าน LINE Official Account เท่านั้น";
      return;
    }

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    const userId = profile.userId;

    if (!userId) {
      document.body.innerText = "ไม่สามารถดึง LINE User ID ได้";
      return;
    }

    const res = await fetch(
      API_URL + "?userId=" + encodeURIComponent(userId),
      { cache: "no-store" }
    );

    const result = await res.json();

    if (result.allowed === true) {
      location.replace("catalog.html");
    } else {
      document.body.innerText =
        "⏳ ยังไม่ได้รับสิทธิ์ใช้งาน\nกรุณาติดต่อผู้ดูแลระบบ";
    }

  } catch (err) {
    document.body.innerText = "เกิดข้อผิดพลาด: " + err.message;
  }
}

start();
</script>
</body>
</html>
