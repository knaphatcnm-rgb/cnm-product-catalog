<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CNM Interior ‚Äì Product Catalog</title>

  <!-- ===== STYLE ===== -->
  <style>
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f4f4f4;
      color:#333;
    }
    header{
      background:#111;
      color:#fff;
      padding:16px;
      text-align:center;
      font-size:18px;
    }
    .container{ padding:12px; }
    .card{
      background:#fff;
      border-radius:14px;
      margin-bottom:16px;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .card img{
      width:100%;
      height:220px;
      object-fit:cover;
      background:#eee;
    }
    .content{ padding:14px; }
    .code{ font-size:12px;color:#888; }
    .name{ font-size:16px;font-weight:600;margin:6px 0; }
    .size{ font-size:14px;color:#555;margin-bottom:8px; }
    .price{ font-size:18px;font-weight:700;color:#0a7cff;margin-bottom:10px; }
    .btn{
      display:block;
      text-align:center;
      padding:10px;
      background:#0a7cff;
      color:#fff;
      border-radius:10px;
      text-decoration:none;
      font-size:14px;
    }

    /* ===== LOCK SCREEN ===== */
    #lock{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:24px;
    }
    #catalog{ display:none; }
  </style>
</head>

<body>

<div id="lock">
  <div>
    <h2>üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h2>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‚Ä¶</p>
  </div>
</div>

<div id="catalog">
  <header>CNM Interior Product Catalog</header>
  <div class="container" id="products"></div>
</div>

<!-- ===== LIFF SDK ===== -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
/* ===================================================
   CONFIG (‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 3 ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ)
=================================================== */
const LIFF_ID = "2008736700-X7cUjaUv";

/* APPROVED USERS (Form_Responses sheet index = 0) */
const APPROVED_USERS_URL =
  "https://opensheet.elk.sh/1E0INtYPUHooDTuOm1KtU8UTHpcYIr9bOLODZqxuL0/0";

/* PRODUCT CSV */
const PRODUCT_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDhv-ti8VG4RV7TjgJqVz4kMRuWcY_nbqhcvW6WdjPUJwa4T6qFNUHBq47RjN5wDGRtKdI23BpdKpl/pub?output=csv";

/* ===================================================
   CSV PARSER
=================================================== */
function parseCSV(text){
  const rows=[], row=[], val="";
  let r=[], v="", q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c=='"'&&n=='"'){v+='"';i++}
    else if(c=='"') q=!q;
    else if(c==','&&!q){r.push(v);v=""}
    else if((c=='\n'||c=='\r')&&!q){
      if(v||r.length) r.push(v);
      if(r.length) rows.push(r);
      r=[];v="";
    } else v+=c;
  }
  if(v||r.length){r.push(v);rows.push(r)}
  return rows;
}

/* ===================================================
   MAIN ACCESS CHECK
=================================================== */
async function checkAccess(){
  console.log("=== CHECK ACCESS START ===");

  await liff.init({ liffId: LIFF_ID });
  console.log("LIFF INIT OK");

  if(!liff.isLoggedIn()){
    console.log("NOT LOGIN ‚Üí LOGIN");
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  console.log("PROFILE =", profile);

  const myName = profile.displayName?.trim();
  console.log("MY DISPLAY NAME =", myName);

  const res = await fetch(APPROVED_USERS_URL);
  const rows = await res.json();

  console.log("ROWS FROM SHEET =", rows);

  const user = rows.find(r =>
    (r["LINE Display Name"] || "").trim() === myName
  );

  console.log("FOUND USER =", user);

  if(!user){
    document.getElementById("lock").innerHTML = `
      <div>
        <h2>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      </div>`;
    return;
  }

  if(user.status !== "approved"){
    document.getElementById("lock").innerHTML = `
      <div>
        <h2>‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
        <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${user.status}</p>
      </div>`;
    return;
  }

  console.log("ACCESS GRANTED ‚úÖ");

  document.getElementById("lock").style.display="none";
  document.getElementById("catalog").style.display="block";

  loadCatalog();
}

/* ===================================================
   LOAD PRODUCT CATALOG
=================================================== */
function loadCatalog(){
  fetch(PRODUCT_CSV)
    .then(r=>r.text())
    .then(text=>{
      const rows=parseCSV(text);
      const headers=rows.shift();
      const box=document.getElementById("products");
      box.innerHTML="";

      rows.forEach(row=>{
        const p={};
        headers.forEach((h,i)=>p[h]=(row[i]||"").trim());

        let img=p["image_url"]||"";
        if(!img && p["Drive_raw"]){
          const m=p["Drive_raw"].match(/\/d\/([^/]+)/);
          if(m) img=`https://lh3.googleusercontent.com/d/${m[1]}=w1200`;
        }

        const price=Number((p["‡∏£‡∏≤‡∏Ñ‡∏≤"]||"").replace(/,/g,""));
        const priceText=!isNaN(price)?price.toLocaleString()+" ‡∏ö‡∏≤‡∏ó":"";

        box.insertAdjacentHTML("beforeend",`
          <div class="card">
            <img src="${img}" onerror="this.src='https://via.placeholder.com/400x220?text=No+Image'">
            <div class="content">
              <div class="code">${p["Code"]||""}</div>
              <div class="name">${p["NAME"]||""}</div>
              <div class="size">${p["‡∏Ç‡∏ô‡∏≤‡∏î"]||""}</div>
              <div class="price">${priceText}</div>
              <a class="btn" href="${p["LINK"]||"#"}" target="_blank">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
            </div>
          </div>
        `);
      });
    });
}

/* ===================================================
   START
=================================================== */
checkAccess();
</script>

</body>
</html>
